<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <style>
    ol#test-results > li.passed { background-color: #E4FFE4; }
    ol#test-results > li.failed { background-color: #FFE4E4; }
  </style>
  <script src="../src/test_it.js"></script>
</head>
<body>
  <ol id="test-results">
  </ol>
  <script>
var testResults=document.getElementById('test-results'),
    report = function(expected, actual){
      var element = document.createElement('li');
      element.innerHTML = "Expected '"+expected+"'";
      if (expected === actual){
        element.className = 'passed';
      } else {
        element.className = 'failed';
        element.innerHTML += " but was '"+actual+"'";
      }
      testResults.appendChild(element);
    };

var calls, results;
TestIt('before/after tests and contexts', {
  'before all': function(t){
    calls = [];
    results = TestIt('the tests', {
      'before all':  function(){ calls.push('before all');  },
      'before each': function(){ calls.push('before each'); },
      'after all':   function(){ calls.push('after all');   },
      'after each':  function(){ calls.push('after each');  },
      'should work': function(){ calls.push('should work'); },
      'context name': {
        'before all':       function(){ calls.push('context before all');  },
        'before each':      function(){ calls.push('context before each'); },
        'after all':        function(){ calls.push('context after all');   },
        'after each':       function(){ calls.push('context after each');  },
        'should work':      function(){ calls.push('context should work'); },
        'should also work': function(){ calls.push('context should also work'); },
        'should not work':  function(t){ calls.push('context should not work'); t.assert(false, 'nope'); },
        'should raise':     function(){ calls.push('context should raise'); throw 'ouch'; }
      },
      'should also work': function(){ calls.push('should also work'); }
    });
  },
  'should be in order': function(t){
    var expected = [];
    expected.push('before all');
      expected.push('before each');
      expected.push('should work');
      expected.push('after each');

      expected.push('context before all');
        expected.push('before each');
        expected.push('context before each');
        expected.push('context should work');
        expected.push('context after each');
        expected.push('after each');

        expected.push('before each');
        expected.push('context before each');
        expected.push('context should also work');
        expected.push('context after each');
        expected.push('after each');

        expected.push('before each');
        expected.push('context before each');
        expected.push('context should not work');
        expected.push('context after each');
        expected.push('after each');

        expected.push('before each');
        expected.push('context before each');
        expected.push('context should raise');
        expected.push('context after each');
        expected.push('after each');
      expected.push('context after all');

      expected.push('before each');
      expected.push('should also work');
      expected.push('after each');
    expected.push('after all');
    for(var i=0,e;e=expected[i];i++){
      report(e, calls[i]);
    }
    t.assertEqual(expected, calls);
  },
  'should return results': function(t){
    var keys;

    keys = [];
    for (var key in results) { keys.push(key); }
    report(1, keys.length);
    report('the tests', keys[0]);

    keys = [];
    for (var key in TestIt.try(results,'the tests')) { keys.push(key); }
    report(3, keys.length);
    report('should work', keys[0]);
    report('context name', keys[1]);
    report('should also work', keys[2]);

    report('pass',  TestIt.try(results,'the tests','should work','result'));
    report('pass',  TestIt.try(results,'the tests','context name','should work','result'));
    report('fail',  TestIt.try(results,'the tests','context name','should not work','result'));
    report('nope',  TestIt.try(results,'the tests','context name','should not work','message'));
    report('error', TestIt.try(results,'the tests','context name','should raise','result'));
    report('ouch',  TestIt.try(results,'the tests','context name','should raise','message'));

    t.assertEqual('pass',  TestIt.try(results,'the tests','should work','result'));
    t.assertEqual('pass',  TestIt.try(results,'the tests','context name','should work','result'));
    t.assertEqual('fail',  TestIt.try(results,'the tests','context name','should not work','result'));
    t.assertEqual('nope',  TestIt.try(results,'the tests','context name','should not work','message'));
    t.assertEqual('error', TestIt.try(results,'the tests','context name','should raise','result'));
    t.assertEqual('ouch',  TestIt.try(results,'the tests','context name','should raise','message'));
  }
});

TestIt('exceptions', {
  'in "before all"': {
    'before all': function(t){
      calls = [];
      results = TestIt('tests', {
        'before all': function(){ throw 'out'; },
        'after all': function(){ calls.push('after all'); },
        'a test': function(){ calls.push('a test'); }
      });
    },
    'should be reported': function(t){
      report('error', TestIt.try(results,'tests','before all','result'));
      report('out', TestIt.try(results,'tests','before all','message'));
      t.assertEqual('error', TestIt.try(results,'tests','before all','result'));
      t.assertEqual('out', TestIt.try(results,'tests','before all','message'));
    },
    'should run the "after all"': function(t){
      report(1, calls.length);
      report('after all', calls[0]);
    },
    'should not run test': function(t){
      report(1, calls.length);

      t.assertEqual(1, calls.length);
      t.assert(calls[0] !== 'a test');
    }
  },
  'in "before each"': {
    'before all': function(t){
      calls = [];
      results = TestIt('tests', {
        'before each': function(){ throw 'out'; },
        'after each': function(){ calls.push('after each'); },
        'after all': function(){ calls.push('after all'); },
        'a test': function(){ calls.push('a test'); }
      });
    },
    'should be reported': function(t){
      report('error', TestIt.try(results,'tests','a test','result'));
      report('out', TestIt.try(results,'tests','a test','message'));
      t.assertEqual('error', TestIt.try(results,'tests','a test','result'));
      t.assertEqual('out', TestIt.try(results,'tests','a test','message'));
    },
    'should run the "after each"': function(t){
      report(2, calls.length);
      report('after each', calls[0]);

      t.assertEqual(2, calls.length);
      t.assertEqual('after each', calls[0]);
    },
    'should run the "after all"': function(t){
      report(2, calls.length);
      report('after all', calls[1]);

      t.assertEqual(2, calls.length);
      t.assertEqual('after all', calls[1]);
    },
    'should not run test': function(t){
      report(2, calls.length);

      t.assertEqual(2, calls.length);
      t.assert(calls[0] !== 'a test' && calls[1] !== 'a test');
    }
  },
  'in "after each"': {
    'before all': function(t){
      calls = [];
      results = TestIt('tests', {
        'after each': function(){ throw 'out'; },
        'after all': function(){ calls.push('after all'); },
        'a test': function(){ }
      });
    },
    'should be reported': function(t){
      report('error', TestIt.try(results,'tests','a test','result'));
      report('out', TestIt.try(results,'tests','a test','message'));
      t.assertEqual('error', TestIt.try(results,'tests','a test','result'));
      t.assertEqual('out', TestIt.try(results,'tests','a test','message'));
    },
    'should run the "after all"': function(t){
      report(1, calls.length);
      report('after all', calls[0]);
    },
  }
});

TestIt('assertions', {
  'assert': {
    'should not raise if passed true': function(t){
      var raised = 'did not raise';
      try {
        t.assert(true);
      } catch (e) {
        raised = 'did raise';
      }
      report('did not raise', raised);
    },
    'should raise if passed false': function(t){
      var raised = 'did not raise';
      try {
        t.assert(false);
      } catch (e) {
        raised = 'did raise';
      }
      report('did raise', raised);
    },
    'should raise with a TestIt.Assertions.Failure': function(t){
      var exception;
      try {
        t.assert(false);
      } catch (e) {
        exception = e;
      }
      report(TestIt.Assertions.Failure, exception.constructor);
    },
    'should raise with a message': function(t){
      var exception;
      try {
        t.assert(false, 'it should have been true');
      } catch (e) {
        exception = e;
      }
      report('it should have been true', exception.message);
    }
  },
  'assertEqual': {
    'should not raise when arrays are equal': function(t){
      var raised = 'did not raise';
      try {
        t.assertEqual([1,2,3], [1,2,3]);
      } catch (e) {
        raised = 'did raise';
      }
      report('did not raise', raised);
    },
    'should raise when arrays are not equal': function(t){
      var raised = 'did not raise';
      try {
        t.assertEqual([1,2,3], [1,3,2]);
      } catch (e) {
        raised = 'did raise';
      }
      report('did raise', raised);
    }
  }
});
  </script>
</body>
</html>

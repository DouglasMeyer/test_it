<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <style>
    #test-it-results { list-style-type: none; margin: 0; padding: 0; }
    #test-it-results > .summary { cursor: pointer; padding: 4px; border-width: 2px; border-style: solid; }
    #test-it-results > li { margin: 2px 0 0 0; padding: 1px; display: none; }
    #test-it-results.show-passing > li { display: block; }
    #test-it-results > .summary { font-size: 150%; display: block; }
    #test-it-results > .running { background-color: #AAAAAA; border-color: #727272; display: block; }
    #test-it-results > .pass  { background-color: #E4FFE4; border-color: #98AA98; }
    #test-it-results > .fail  { background-color: #FFB0B0; border-color: #AA7676; display: block; }
    #test-it-results > .error { background-color: #FF4040; border-color: #AA2B2B; display: block; }
  </style>
  <script src="../src/test_it.js"></script>
  <script>
var calls, results, log,
    fakeTestItReporter = function(results){
      log = this.constructor.log = [];
      log.appendChild = log.push;
      this.reportContext(results);
    };
fakeTestItReporter.prototype = new TestIt.Reporter;
fakeTestItReporter.prototype.constructor = fakeTestItReporter;
TestIt('before/after tests and contexts', {
  'before all': function(t){
    calls = [];
    results = TestIt('the tests', {
      'before all':  function(){ calls.push('before all');  },
      'before each': function(){ calls.push('before each'); },
      'after all':   function(){ calls.push('after all');   },
      'after each':  function(){ calls.push('after each');  },
      'should work': function(){ calls.push('should work'); },
      'context name': {
        'before all':       function(){ calls.push('context before all');  },
        'before each':      function(){ calls.push('context before each'); },
        'after all':        function(){ calls.push('context after all');   },
        'after each':       function(){ calls.push('context after each');  },
        'should work':      function(){ calls.push('context should work'); },
        'should also work': function(){ calls.push('context should also work'); },
        'should not work':  function(t){ calls.push('context should not work'); t.assert(false, 'nope'); },
        'should raise':     function(){ calls.push('context should raise'); throw 'ouch'; }
      },
      'should also work': function(){ calls.push('should also work'); }
    }, fakeTestItReporter);
  },
  'should be in order': function(t){
    var expected = [];
    expected.push('before all');
      expected.push('before each');
      expected.push('should work');
      expected.push('after each');

      expected.push('context before all');
        expected.push('before each');
        expected.push('context before each');
        expected.push('context should work');
        expected.push('context after each');
        expected.push('after each');

        expected.push('before each');
        expected.push('context before each');
        expected.push('context should also work');
        expected.push('context after each');
        expected.push('after each');

        expected.push('before each');
        expected.push('context before each');
        expected.push('context should not work');
        expected.push('context after each');
        expected.push('after each');

        expected.push('before each');
        expected.push('context before each');
        expected.push('context should raise');
        expected.push('context after each');
        expected.push('after each');
      expected.push('context after all');

      expected.push('before each');
      expected.push('should also work');
      expected.push('after each');
    expected.push('after all');
    t.assertEqual(expected, calls);
  },
  'should return results': function(t){
    var keys;

    keys = [];
    for (var key in results) { keys.push(key); }
    t.assertEqual(['the tests'], keys);

    keys = [];
    for (var key in results['the tests']) { keys.push(key); }
    t.assertEqual(['should work', 'context name', 'should also work'], keys);

    t.assertEqual('pass',  results['the tests']['should work']['result']);
    t.assertEqual('pass',  results['the tests']['context name']['should work']['result']);
    t.assertEqual('fail',  results['the tests']['context name']['should not work']['result']);
    t.assertEqual('nope',  results['the tests']['context name']['should not work']['message']);
    t.assertEqual('error', results['the tests']['context name']['should raise']['result']);
    t.assertEqual('ouch',  results['the tests']['context name']['should raise']['message']);
  }
});

TestIt('exceptions', {
  'in "before all"': {
    'before all': function(t){
      calls = [];
      results = TestIt('tests', {
        'before all': function(){ throw 'out'; },
        'after all': function(){ calls.push('after all'); },
        'a test': function(){ calls.push('a test'); }
      }, fakeTestItReporter);
    },
    'should be reported': function(t){
      t.assertEqual('error', results['tests']['before all']['result']);
      t.assertEqual('out', results['tests']['before all']['message']);
    },
    'should run the "after all"': function(t){
      t.assertEqual(1, calls.length);
      t.assertEqual('after all', calls[0]);
    },
    'should not run test': function(t){
      t.assertEqual(1, calls.length);
      t.assert(calls[0] !== 'a test');
    }
  },
  'in "before each"': {
    'before all': function(t){
      calls = [];
      results = TestIt('tests', {
        'before each': function(){ throw 'out'; },
        'after each': function(){ calls.push('after each'); },
        'after all': function(){ calls.push('after all'); },
        'a test': function(){ calls.push('a test'); }
      }, fakeTestItReporter);
    },
    'should be reported': function(t){
      t.assertEqual('error', results['tests']['a test']['result']);
      t.assertEqual('out', results['tests']['a test']['message']);
    },
    'should run the "after each"': function(t){
      t.assertEqual(2, calls.length);
      t.assertEqual('after each', calls[0]);
    },
    'should run the "after all"': function(t){
      t.assertEqual(2, calls.length);
      t.assertEqual('after all', calls[1]);
    },
    'should not run test': function(t){
      t.assertEqual(2, calls.length);
      t.assert(calls[0] !== 'a test' && calls[1] !== 'a test');
    }
  },
  'in "after each"': {
    'before all': function(t){
      calls = [];
      results = TestIt('tests', {
        'after each': function(){ throw 'out'; },
        'after all': function(){ calls.push('after all'); },
        'a test': function(){ }
      }, fakeTestItReporter);
    },
    'should be reported': function(t){
      t.assertEqual('error', results['tests']['a test']['result']);
      t.assertEqual('out', results['tests']['a test']['message']);
    },
    'should run the "after all"': function(t){
      t.assertEqual(1, calls.length);
      t.assertEqual('after all', calls[0]);
    },
  }
});

TestIt('running assertions', {
  'in "before all"': {
    'before all': function(){
      results = TestIt('tests', {
        'before all': function(t){ t.assert(false); },
        'a test': function(){ }
      }, fakeTestItReporter);
    },
    'should be reported': function(t){
      t.assertEqual(1, results['tests']['before all']['assertions']['length']);
    }
  },
  'in "before each"': {
    'before all': function(){
      results = TestIt('tests', {
        'before each': function(t){ t.assert(false); },
        'a test': function(){ }
      }, fakeTestItReporter);
    },
    'should be reported': function(t){
      t.assertEqual(1, results['tests']['a test']['assertions']['length']);
    }
  },
  'in "after each"': {
    'before all': function(){
      results = TestIt('tests', {
        'after each': function(t){ t.assert(false); },
        'a test': function(){ }
      }, fakeTestItReporter);
    },
    'should be reported': function(t){
      t.assertEqual(1, results['tests']['a test']['assertions']['length']);
    }
  },
  'in "after all"': {
    'before all': function(){
      results = TestIt('tests', {
        'after all': function(t){ t.assert(false); },
        'a test': function(){ }
      }, fakeTestItReporter);
    },
    'should be reported': function(t){
      t.assertEqual(1, results['tests']['after all']['assertions']['length']);
    }
  }
});

TestIt('assertions', {
  'assert': {
    'should not raise if passed true': function(t){
      var raised = 'did not raise';
      try {
        t.assert(true);
      } catch (e) {
        raised = 'did raise';
      }
      t.assertEqual('did not raise', raised);
    },
    'should raise if passed false': function(t){
      var raised = 'did not raise';
      try {
        t.assert(false);
      } catch (e) {
        raised = 'did raise';
      }
      t.assertEqual('did raise', raised);
    },
    'should raise with a TestIt.Assertions.Failure': function(t){
      var exception;
      try {
        t.assert(false);
      } catch (e) {
        exception = e;
      }
      t.assertEqual(TestIt.Assertions.Failure, exception.constructor);
    },
    'should raise with a default message': function(t){
      var exception;
      try {
        t.assert(false);
      } catch (e) {
        exception = e;
      }
      t.assertEqual('false is not true', exception.message);
    },
    'should raise with a message': function(t){
      var exception;
      try {
        t.assert(false, 'it should have been true');
      } catch (e) {
        exception = e;
      }
      t.assertEqual('it should have been true', exception.message);
    }
  },
  'assertEqual': {
    'should not raise when arrays are equal': function(t){
      var raised = 'did not raise';
      try {
        t.assertEqual([1,2,3], [1,2,3]);
      } catch (e) {
        raised = 'did raise';
      }
      t.assertEqual('did not raise', raised);
    },
    'should raise when arrays are not equal': function(t){
      var raised = 'did not raise';
      try {
        t.assertEqual([1,2,3], [1,3,2]);
      } catch (e) {
        raised = 'did raise';
      }
      t.assertEqual('did raise', raised);
    },
    'should raise with a default message': function(t){
      var exception;
      try {
        t.assertEqual([1,2,3], [3,2,1]);
      } catch (e) {
        exception = e;
      }
      t.assertEqual('expected [1,2,3] but was [3,2,1]', exception.message);
    },
  }
});

TestIt('reporting', {
  'before all': function(){
    TestIt('tests', {
      '1 test': function(t){ t.assert(true); },
      '2 test': function(t){ t.assert(false, 'fail message'); },
      '3 test': function(t){ throw 'out'; }
    }, fakeTestItReporter);
  },
  'should report passing tests': function(t){
    t.assertEqual('tests: 1 test: pass (1 assertion run)', log[0]['textContent']);
    t.assertEqual('pass', log[0]['className']);
  },
  'should report failing tests': function(t){
    t.assertEqual('tests: 2 test: fail: fail message (1 assertion run)', log[1]['textContent']);
    t.assertEqual('fail', log[1]['className']);
  },
  'should report erroring tests': function(t){
    t.assertEqual('tests: 3 test: error: out (0 assertions run)', log[2]['textContent']);
    t.assertEqual('error', log[2]['className']);
  }
});

(function(){
var inspectTests = function(input){
  var tests = {};
  while(input.length >= 3){
    (function(){
      var subject = input.shift(),
          outcome = input.shift(),
          description = input.shift();
      tests[description+" '"+subject+"' should yield '"+outcome+"'"] = function(t){
        t.assertEqual(outcome, TestIt.inspect(subject));
      }
    })();
  }
  return tests;
};
TestIt('TestIt.inspect', inspectTests([
  1, '1', 'Integer',
  '1', '"1"', 'String',
  [1,2,3], '[1,2,3]', 'Array',
  ['a','b'], '["a","b"]', 'Array of Strings',
  undefined, 'undefined', 'Undefined'
]));
})();

window.waitForCallbackCalled = false;
var start = new Date();
TestIt.waitFor(function(){
  return (new Date()) - start > 500;
}, function(){
  window.waitForCallbackCalled = true;
});
setTimeout(function(){
  TestIt('waitFor', {
    'should have waited for condition, then ran callback': function(t){
      t.assert(window.waitForCallbackCalled);
    }
  });
}, 1000);

(function(){
var calls;
TestIt('waitFor', {
  'before all': function(){
    calls = [];
    var counter = 0;
    TestIt('tests', {
      'before all': function(t){
        var name = 'before all';
        calls.push(name);
        t.waitFor(function(){
          return counter++ > 10;
        }, function(){
          calls.push(name+' callback');
        });
      }, 'before each': function(t){
        var name = 'before each';
        calls.push(name);
        t.waitFor(function(){
          return counter++ > 20;
        }, function(){
          calls.push(name+' callback');
        });
      }, 'test': function(t){
        var name = 'test';
        calls.push(name);
        t.waitFor(function(){
          return counter++ > 30;
        }, function(){
          calls.push(name+' callback');
        });
      }, 'after each': function(t){
        var name = 'after each';
        calls.push(name);
        t.waitFor(function(){
          return counter++ > 40;
        }, function(){
          calls.push(name+' callback');
        });
      }, 'after all': function(t){
        var name = 'after all';
        calls.push(name);
        t.waitFor(function(){
          return counter++ > 50;
        }, function(){
          calls.push(name+' callback');
        });
      }
    }, fakeTestItReporter);
  },
  'should delay each call until the callbacks are called': function(t){
    var start = new Date();
    t.waitFor(function(){
      return (new Date()) - start > (50+25)*100;
    }, function(){
      var expected = [
        'before all', 'before all callback',
        'before each', 'before each callback',
        'test', 'test callback',
        'after each', 'after each callback',
        'after all', 'after all callback'
      ];
      t.assertEqual(expected, calls);
    });
  }
});
})();
  </script>
</head>
<body>
</body>
</html>
